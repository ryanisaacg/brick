use crate::typecheck::{ExpressionType, PointerKind};

use super::{HirModule, HirNode, HirNodeValue};

// TODO: remove 'CallGenerator' as a concept? rework it?
pub fn rewrite_generator_calls(module: &mut HirModule) {
    module.visit_mut(|node| {
        let HirNodeValue::Call(func, args) = &mut node.value else {
            return;
        };
        if !matches!(&func.ty, &ExpressionType::Generator { .. }) {
            return;
        }

        let mut generator = HirNode::dummy();
        std::mem::swap(func.as_mut(), &mut generator);

        let function_id = HirNode::autogenerated(
            HirNodeValue::Access(Box::new(generator.clone()), "function".to_string()),
            // TODO: wrong expression type
            ExpressionType::Void,
        );

        let gen_ty = generator.ty.clone();

        args.insert(
            0,
            HirNode::autogenerated(
                HirNodeValue::TakeUnique(Box::new(generator)),
                ExpressionType::Pointer(PointerKind::Unique, Box::new(gen_ty)),
            ),
        );

        **func = function_id;
    });
}
